<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stretching Guide - Voice Guided Routine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #2c3e50;
            line-height: 1.5;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 3em;
            margin: 0;
        }
        
        .main-display {
            background: white;
            border-radius: 12px;
            padding: 40px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .stretch-name {
            font-size: 1.8em;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .stretch-side {
            font-size: 1.1em;
            color: #6c757d;
            margin-bottom: 15px;
        }
        
        .stretch-info {
            color: #495057;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .stretch-instructions {
            color: #6c757d;
            font-size: 0.95em;
            margin-bottom: 25px;
            font-style: italic;
        }
        
        .timer-display {
            font-size: 3.5em;
            font-weight: 300;
            color: #495057;
            margin: 25px 0;
            font-variant-numeric: tabular-nums;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0 15px;
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
            margin: 15px 0 25px;
        }
        
        .progress-fill {
            height: 100%;
            background: #495057;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .transition-indicator {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 12px;
            margin: 20px 0;
            text-align: center;
            color: #856404;
            font-size: 0.9em;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .btn {
            padding: 16px 20px;
            border: none;
            border-radius: 12px;
            font-size: 1.4em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 60px;
            min-height: 60px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-primary {
            background: #495057;
            color: white;
        }
        
        .btn-primary:hover {
            background: #343a40;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-outline {
            background: transparent;
            color: #495057;
            border: 1px solid #dee2e6;
        }
        
        .btn-outline:hover {
            background: #f8f9fa;
            border-color: #adb5bd;
        }
        
        .settings-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
        }
        
        .settings-panel h2 {
            margin-bottom: 20px;
            font-size: 1.3em;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .settings-panel h3 {
            margin: 25px 0 15px;
            font-size: 1.1em;
            font-weight: 600;
            color: #495057;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }
        
        .setting-group {
            margin-bottom: 20px;
        }
        
        .setting-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #495057;
            font-size: 0.9em;
        }
        
        .setting-group input, .setting-group select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 1.1em;
            background: white;
            min-height: 44px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        .setting-group input:focus, .setting-group select:focus {
            outline: none;
            border-color: #495057;
            box-shadow: 0 0 0 2px rgba(73, 80, 87, 0.1);
        }
        
        .setting-group small {
            color: #6c757d;
            font-size: 0.8em;
            margin-top: 4px;
            display: block;
        }
        
        .stretch-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .stretch-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: white;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        
        .stretch-details {
            flex-grow: 1;
        }
        
        .stretch-title {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        
        .stretch-meta {
            font-size: 0.85em;
            color: #6c757d;
        }
        
        .screen-wake-hint {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8em;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .screen-wake-hint.show {
            opacity: 1;
        }
        
        .hidden { 
            display: none; 
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .main-display {
                padding: 20px;
                margin-bottom: 15px;
            }
            
            .controls {
                gap: 12px;
            }
            
            .btn {
                min-width: 55px;
                min-height: 55px;
                padding: 14px 16px;
                font-size: 1.3em;
            }
            
            .stretch-name {
                font-size: 1.4em;
            }
            
            .timer-display {
                font-size: 3em;
                margin: 20px 0;
            }
            
            .progress-info {
                flex-direction: column;
                gap: 8px;
                font-size: 1em;
            }
            
            .settings-panel {
                padding: 20px;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .setting-group input, .setting-group select {
                font-size: 1.2em;
                padding: 14px 16px;
                min-height: 48px;
            }
            
            .header h1 {
                font-size: 4em;
                margin-bottom: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 8px;
            }
            
            .timer-display {
                font-size: 2.5em;
            }
            
            .stretch-name {
                font-size: 1.2em;
            }
            
            .main-display {
                padding: 15px;
            }
            
            .btn {
                min-width: 50px;
                min-height: 50px;
                padding: 12px 14px;
                font-size: 1.2em;
            }
        }
        
        /* Prevent zoom on iOS when focusing inputs */
        @media screen and (-webkit-min-device-pixel-ratio: 0) {
            select, textarea, input[type="text"], input[type="number"] {
                font-size: 16px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>🧘‍♀️</h1>
        </header>
        
        <div class="main-display" id="mainDisplay">
            <div class="stretch-name" id="stretchName">Ready to Start</div>
            <div class="stretch-side" id="stretchSide"></div>
            <div class="stretch-info" id="stretchInfo">Press Start to begin your stretching routine</div>
            <div class="stretch-instructions" id="stretchInstructions"></div>
            <div class="timer-display" id="timerDisplay">0:00</div>
            <div class="progress-info">
                <span id="currentStretch">Stretch 0 of 0</span>
                <span id="timeRemaining">Total: 0:00</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="transition-indicator hidden" id="transitionIndicator">
                🔄 Transition time - Get ready for the next stretch
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" id="playPauseBtn">▶️</button>
            <button class="btn btn-outline" id="stopBtn">⏹️</button>
            <button class="btn btn-outline" id="backBtn">⏮️</button>
            <button class="btn btn-outline" id="skipBtn">⏭️</button>
            <button class="btn btn-outline" id="settingsBtn">⚙️</button>
        </div>
        
        <div class="screen-wake-hint" id="screenWakeHint">
            Tap screen occasionally to keep it awake
        </div>
        
        <div class="settings-panel hidden" id="settingsPanel">
            <h2>Settings</h2>
            <div class="settings-grid">
                <div>
                    <div class="setting-group">
                        <label>Voice</label>
                        <select id="voiceSelect">
                            <option value="">Loading voices...</option>
                        </select>
                        <button class="btn btn-outline" style="margin-top: 8px; padding: 6px 12px; font-size: 0.8em;" id="testVoiceBtn">Test Voice</button>
                    </div>
                    
                    <div class="setting-group">
                        <label>Voice Speed</label>
                        <input type="range" id="voiceSpeed" min="0.5" max="2" step="0.1" value="1">
                        <span id="speedValue">1.0x</span>
                    </div>
                    
                    <div class="setting-group">
                        <label>Voice Pitch</label>
                        <input type="range" id="voicePitch" min="0.5" max="2" step="0.1" value="1">
                        <span id="pitchValue">1.0</span>
                    </div>
                </div>
                
                <div>
                    <div class="setting-group">
                        <label>Transition Time</label>
                        <input type="number" id="transitionTime" min="5" max="30" value="15">
                        <small>Seconds between different stretches</small>
                    </div>
                    
                    <div class="setting-group">
                        <label>Countdown Warning</label>
                        <input type="number" id="countdownWarning" min="3" max="10" value="5">
                        <small>When to start countdown</small>
                    </div>
                </div>
            </div>
            
            <h3>Current Routine</h3>
            <div class="stretch-list" id="stretchList"></div>
            
            <h3>Edit Routine</h3>
            <div class="setting-group">
                <label>Add New Stretch</label>
                <input type="text" id="newStretchName" placeholder="Stretch name">
                <input type="text" id="newStretchDescription" placeholder="Instructions (e.g., hands and knees, arch spine)">
                <input type="number" id="newStretchDuration" placeholder="Duration (seconds)" value="60">
                <select id="newStretchSides">
                    <option value="none">No sides</option>
                    <option value="both">Left & Right</option>
                </select>
                <input type="text" id="newStretchTarget" placeholder="Target area">
                <button class="btn btn-primary" id="addStretchBtn" style="margin-top: 10px;">Add Stretch</button>
            </div>
        </div>
    </div>

    <script>
        // Complete stretching routine with instructions
        let stretches = [
            { 
                name: "Cat-Cow", 
                target: "Spine warm-up", 
                duration: 60, 
                sides: "none", 
                icon: "🐱",
                description: "Hands and knees, arch and round spine",
                searchTerms: "cat cow stretch yoga pose tabletop"
            },
            { 
                name: "Standing Arm Swings", 
                target: "Shoulders warm-up", 
                duration: 60, 
                sides: "none", 
                icon: "🤸‍♀️",
                description: "Arms at shoulder height, swing across chest",
                searchTerms: "standing arm swings dynamic stretch shoulder"
            },
            { 
                name: "Posterior Pelvic Tilt Hip Flexor Stretch", 
                target: "Hip flexors, quads", 
                duration: 60, 
                sides: "right", 
                icon: "🦵",
                description: "Lunge position with pelvic tilt",
                searchTerms: "posterior pelvic tilt hip flexor stretch lunge"
            },
            { 
                name: "Posterior Pelvic Tilt Hip Flexor Stretch", 
                target: "Hip flexors, quads", 
                duration: 60, 
                sides: "left", 
                icon: "🦵",
                description: "Lunge position with pelvic tilt",
                searchTerms: "posterior pelvic tilt hip flexor stretch lunge"
            },
            { 
                name: "90/90 Hip Stretch", 
                target: "Glutes, hip rotators", 
                duration: 60, 
                sides: "right", 
                icon: "🧘‍♀️",
                description: "Seated with both legs at 90 degrees",
                searchTerms: "90 90 hip stretch seated figure four"
            },
            { 
                name: "90/90 Hip Stretch", 
                target: "Glutes, hip rotators", 
                duration: 60, 
                sides: "left", 
                icon: "🧘‍♀️",
                description: "Seated with both legs at 90 degrees",
                searchTerms: "90 90 hip stretch seated figure four"
            },
            { 
                name: "Child's Pose Side Reach", 
                target: "Lower back, lats", 
                duration: 30, 
                sides: "center", 
                icon: "🧘‍♂️",
                description: "Kneeling, arms extended overhead",
                searchTerms: "child's pose side reach yoga stretch"
            },
            { 
                name: "Child's Pose Side Reach", 
                target: "Lower back, lats", 
                duration: 30, 
                sides: "right", 
                icon: "🧘‍♂️",
                description: "Reach arms to one side in child's pose",
                searchTerms: "child's pose side reach lateral stretch"
            },
            { 
                name: "Child's Pose Side Reach", 
                target: "Lower back, lats", 
                duration: 30, 
                sides: "left", 
                icon: "🧘‍♂️",
                description: "Reach arms to one side in child's pose",
                searchTerms: "child's pose side reach lateral stretch"
            },
            { 
                name: "Thread the Needle", 
                target: "Thoracic spine, rear delts", 
                duration: 60, 
                sides: "right", 
                icon: "🪡",
                description: "From tabletop, thread arm under body",
                searchTerms: "thread the needle stretch thoracic spine"
            },
            { 
                name: "Thread the Needle", 
                target: "Thoracic spine, rear delts", 
                duration: 60, 
                sides: "left", 
                icon: "🪡",
                description: "From tabletop, thread arm under body",
                searchTerms: "thread the needle stretch thoracic spine"
            },
            { 
                name: "Doorway Pec Stretch", 
                target: "Chest, anterior shoulders", 
                duration: 60, 
                sides: "none", 
                icon: "🚪",
                description: "Arm against doorframe, lean forward",
                searchTerms: "doorway pec stretch chest shoulder"
            },
            { 
                name: "Prone W Lift-Offs", 
                target: "Rear delts, rhomboids", 
                duration: 60, 
                sides: "none", 
                icon: "✋",
                description: "Lying face down, lift arms in W shape",
                searchTerms: "prone W lift off exercise rear delt"
            },
            { 
                name: "Half-Kneeling Hamstring Stretch", 
                target: "Hamstrings", 
                duration: 60, 
                sides: "right", 
                icon: "🦵",
                description: "One knee down, extend opposite leg",
                searchTerms: "half kneeling hamstring stretch"
            },
            { 
                name: "Half-Kneeling Hamstring Stretch", 
                target: "Hamstrings", 
                duration: 60, 
                sides: "left", 
                icon: "🦵",
                description: "One knee down, extend opposite leg",
                searchTerms: "half kneeling hamstring stretch"
            },
            { 
                name: "Downward Dog Pedal", 
                target: "Calves, hamstrings", 
                duration: 60, 
                sides: "none", 
                icon: "🐕",
                description: "Downward dog, alternate heel presses",
                searchTerms: "downward dog pedal calf stretch yoga"
            },
            { 
                name: "Chin Tuck + Levator Scapulae Stretch", 
                target: "Neck extensors", 
                duration: 30, 
                sides: "right", 
                icon: "💆‍♀️",
                description: "Chin back, ear to shoulder",
                searchTerms: "chin tuck levator scapulae neck stretch"
            },
            { 
                name: "Chin Tuck + Levator Scapulae Stretch", 
                target: "Neck extensors", 
                duration: 30, 
                sides: "left", 
                icon: "💆‍♀️",
                description: "Chin back, ear to shoulder",
                searchTerms: "chin tuck levator scapulae neck stretch"
            },
            { 
                name: "Cross-Body Arm Pull with Neck Tilt", 
                target: "Traps, posterior shoulder", 
                duration: 30, 
                sides: "right", 
                icon: "🤗",
                description: "Pull arm across body, tilt head away",
                searchTerms: "cross body arm pull neck tilt stretch"
            },
            { 
                name: "Cross-Body Arm Pull with Neck Tilt", 
                target: "Traps, posterior shoulder", 
                duration: 30, 
                sides: "left", 
                icon: "🤗",
                description: "Pull arm across body, tilt head away",
                searchTerms: "cross body arm pull neck tilt stretch"
            }
        ];

        let currentStretchIndex = 0;
        let timeRemaining = 0;
        let isRunning = false;
        let isPaused = false;
        let timer = null;
        let isTransition = false;
        let selectedVoice = null;
        let voices = [];
        let wakeLock = null;
        let lastInteraction = Date.now();

        // Speech synthesis
        let synth = window.speechSynthesis;
        let voiceSpeed = 1;
        let voicePitch = 1;

        // Load available voices - only the newest, highest quality AI voices
        function loadVoices() {
            voices = synth.getVoices();
            const voiceSelect = document.getElementById('voiceSelect');
            voiceSelect.innerHTML = '<option value="">System Default</option>';
            
            // Filter for only the highest quality voices based on your actual voice list
            const qualityVoices = voices.filter(voice => {
                const name = voice.name;
                const lang = voice.lang.toLowerCase();
                
                // Must be English
                if (!lang.includes('en')) return false;
                
                // Exclude the definitely bad/old/novelty voices
                const excludeNames = [
                    'Bad News', 'Bahh', 'Bells', 'Boing', 'Bubbles', 'Cellos', 'Fred', 
                    'Good News', 'Jester', 'Junior', 'Kathy', 'Organ', 'Ralph', 
                    'Superstar', 'Trinoids', 'Whisper', 'Wobble', 'Zarvox'
                ];
                
                if (excludeNames.includes(name)) return false;
                
                // Include the best quality voices from your list
                const bestVoices = [
                    // Top tier - modern voices
                    'Samantha',
                    // Newer AI voices (Eddy, Flo, Grandma, Grandpa, Reed, Rocko, Sandy, Shelley series)
                    'Eddy (English (United States))', 'Eddy (English (United Kingdom))',
                    'Flo (English (United States))', 'Flo (English (United Kingdom))',
                    'Grandma (English (United States))', 'Grandma (English (United Kingdom))',
                    'Grandpa (English (United States))', 'Grandpa (English (United Kingdom))',
                    'Reed (English (United States))', 'Reed (English (United Kingdom))',
                    'Rocko (English (United States))', 'Rocko (English (United Kingdom))',
                    'Sandy (English (United States))', 'Sandy (English (United Kingdom))',
                    'Shelley (English (United States))', 'Shelley (English (United Kingdom))',
                    // Google voices (very high quality)
                    'Google US English', 'Google UK English Female', 'Google UK English Male',
                    // Other decent voices
                    'Aaron', 'Alice', 'Catherine', 'Ellen', 'Nicky', 'Nora'
                ];
                
                return bestVoices.includes(name);
            });
            
            // Add the quality voices to the dropdown
            qualityVoices.forEach((voice) => {
                const option = document.createElement('option');
                option.value = voices.indexOf(voice);
                option.textContent = voice.name;
                if (voice.default) {
                    option.textContent += ' - Default';
                }
                voiceSelect.appendChild(option);
            });
            
            // If we didn't find many quality voices, something went wrong
            if (qualityVoices.length === 0) {
                console.log('No quality voices found, falling back to all English voices');
                const allEnglishVoices = voices.filter(voice => {
                    return voice.lang.toLowerCase().includes('en');
                });
                
                allEnglishVoices.forEach((voice) => {
                    const option = document.createElement('option');
                    option.value = voices.indexOf(voice);
                    option.textContent = voice.name;
                    if (voice.default) {
                        option.textContent += ' - Default';
                    }
                    voiceSelect.appendChild(option);
                });
            }
        }

        // Load voices when available
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = loadVoices;
        }
        setTimeout(loadVoices, 100);

        function speak(text) {
            if (synth.speaking) {
                synth.cancel();
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = voiceSpeed;
            utterance.pitch = voicePitch;
            utterance.volume = 0.8;
            
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }
            
            synth.speak(utterance);
        }

        function testVoice() {
            speak("This is how your selected voice sounds. Ready to stretch?");
        }

        // Wake lock functionality for keeping screen awake
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Screen wake lock activated');
                    
                    wakeLock.addEventListener('release', () => {
                        console.log('Screen wake lock released');
                    });
                }
            } catch (err) {
                console.log('Wake lock not supported or failed:', err);
                showScreenWakeHint();
            }
        }

        async function releaseWakeLock() {
            if (wakeLock !== null) {
                try {
                    await wakeLock.release();
                    wakeLock = null;
                } catch (err) {
                    console.log('Failed to release wake lock:', err);
                }
            }
        }

        function showScreenWakeHint() {
            const hint = document.getElementById('screenWakeHint');
            hint.classList.add('show');
            setTimeout(() => {
                hint.classList.remove('show');
            }, 3000);
        }

        function trackInteraction() {
            lastInteraction = Date.now();
        }

        // Show wake hint if screen might go to sleep
        function checkScreenWake() {
            if (isRunning && Date.now() - lastInteraction > 25000) { // 25 seconds
                showScreenWakeHint();
                lastInteraction = Date.now(); // Reset timer
            }
        }

        function calculateTotalTime() {
            let total = 0;
            const transitionTime = parseInt(document.getElementById('transitionTime').value);
            
            stretches.forEach((stretch, index) => {
                total += stretch.duration;
                if (index < stretches.length - 1) {
                    const current = stretches[index];
                    const next = stretches[index + 1];
                    // Add transition time for different stretches
                    if (current.name !== next.name) {
                        total += transitionTime;
                    }
                }
            });
            
            return total;
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function getStretchIcon(stretch) {
            return stretch.icon || "🧘‍♀️";
        }

        function updateDisplay() {
            const current = stretches[currentStretchIndex];
            if (!current) return;

            document.getElementById('stretchName').textContent = current.name;
            
            let sideText = '';
            if (current.sides !== "none") {
                sideText = `(${current.sides.charAt(0).toUpperCase() + current.sides.slice(1)} Side)`;
            }
            document.getElementById('stretchSide').textContent = sideText;
            
            document.getElementById('stretchInfo').textContent = current.target;
            document.getElementById('stretchInstructions').textContent = current.description || '';
            
            document.getElementById('timerDisplay').textContent = formatTime(timeRemaining);
            document.getElementById('currentStretch').textContent = `Stretch ${currentStretchIndex + 1} of ${stretches.length}`;
            
            const totalTime = calculateTotalTime();
            const elapsed = totalTime - getRemainingTotalTime();
            const progress = (elapsed / totalTime) * 100;
            document.getElementById('progressFill').style.width = Math.max(0, progress) + '%';
            
            document.getElementById('timeRemaining').textContent = `Remaining: ${formatTime(getRemainingTotalTime())}`;
        }

        function getRemainingTotalTime() {
            let total = timeRemaining;
            const transitionTime = parseInt(document.getElementById('transitionTime').value);
            
            for (let i = currentStretchIndex + 1; i < stretches.length; i++) {
                total += stretches[i].duration;
                if (i < stretches.length - 1) {
                    const current = stretches[i];
                    const next = stretches[i + 1];
                    if (current.name !== next.name) {
                        total += transitionTime;
                    }
                }
            }
            
            return total;
        }

        function togglePlayPause() {
            if (isRunning) {
                // Currently running, so pause
                isPaused = true;
                isRunning = false;
                clearInterval(timer);
                document.getElementById('playPauseBtn').textContent = '▶️';
                releaseWakeLock();
            } else if (isPaused) {
                // Currently paused, so resume
                isPaused = false;
                isRunning = true;
                timer = setInterval(tick, 1000);
                document.getElementById('playPauseBtn').textContent = '⏸️';
                requestWakeLock();
            } else {
                // Not started yet, so start
                startRoutine();
            }
        }

        function startRoutine() {
            currentStretchIndex = 0;
            timeRemaining = stretches[0].duration;
            isRunning = true;
            isPaused = false;
            isTransition = false;

            updateDisplay();
            
            const current = stretches[0];
            let announcement = `Begin ${current.name}`;
            if (current.sides !== "none") {
                announcement += ` ${current.sides}`;
            }
            announcement += ` ${current.duration} seconds`;
            
            speak(announcement);
            
            timer = setInterval(tick, 1000);
            document.getElementById('playPauseBtn').textContent = '⏸️';
            document.getElementById('transitionIndicator').classList.add('hidden');
            
            requestWakeLock();
        }

        function stopRoutine() {
            isRunning = false;
            isPaused = false;
            isTransition = false;
            clearInterval(timer);
            currentStretchIndex = 0;
            timeRemaining = 0;
            
            document.getElementById('stretchName').textContent = 'Ready to Start';
            document.getElementById('stretchSide').textContent = '';
            document.getElementById('stretchInfo').textContent = 'Press Start to begin your stretching routine';
            document.getElementById('stretchInstructions').textContent = '';
            document.getElementById('timerDisplay').textContent = formatTime(calculateTotalTime());
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('currentStretch').textContent = `Stretch 0 of ${stretches.length}`;
            document.getElementById('timeRemaining').textContent = `Total: ${formatTime(calculateTotalTime())}`;
            document.getElementById('playPauseBtn').textContent = '▶️';
            document.getElementById('transitionIndicator').classList.add('hidden');
            
            speak("Routine stopped");
            releaseWakeLock();
        }

        function tick() {
            if (!isRunning) return;

            timeRemaining--;
            
            if (isTransition) {
                // During transition time
                if (timeRemaining <= 0) {
                    // Transition over, start the actual stretch
                    const current = stretches[currentStretchIndex];
                    isTransition = false;
                    timeRemaining = current.duration;
                    document.getElementById('transitionIndicator').classList.add('hidden');
                    speak("Begin");
                }
            } else {
                // During actual stretch time
                if (timeRemaining === 5) {
                    speak("Five");
                }
                
                if (timeRemaining <= 0) {
                    moveToNextStretch();
                }
            }
            
            updateDisplay();
        }

        function moveToNextStretch() {
            currentStretchIndex++;
            
            if (currentStretchIndex >= stretches.length) {
                completeRoutine();
                return;
            }
            
            const current = stretches[currentStretchIndex];
            const previous = stretches[currentStretchIndex - 1];
            
            // Check if this is the same stretch but different side (right → left OR center → right)
            const isSameStretchSequence = current.name === previous.name && 
                                         ((previous.sides === "right" && current.sides === "left") ||
                                          (previous.sides === "center" && current.sides === "right") ||
                                          (previous.sides === "right" && current.sides === "left"));
            
            if (isSameStretchSequence) {
                // For same stretch sequence, just say the side and start immediately
                if (current.sides === "left") {
                    speak("Left");
                } else if (current.sides === "right") {
                    speak("Right");
                } else if (current.sides === "center") {
                    speak("Center");
                }
                timeRemaining = current.duration;
                isTransition = false;
                document.getElementById('transitionIndicator').classList.add('hidden');
            } else {
                // Different stretch - need transition time
                isTransition = true;
                timeRemaining = parseInt(document.getElementById('transitionTime').value);
                document.getElementById('transitionIndicator').classList.remove('hidden');
                
                // Announce the next stretch name during transition
                let announcement = current.name;
                if (current.sides === "right") {
                    announcement += " right";
                } else if (current.sides === "center") {
                    announcement += " center";
                }
                speak(announcement);
            }
        }

        function skipNext() {
            // Skip works in any state - running, paused, or stopped
            if (currentStretchIndex >= stretches.length - 1) return; // Can't skip past last stretch
            
            // Move to next stretch
            currentStretchIndex++;
            
            const current = stretches[currentStretchIndex];
            
            // Reset to the stretch (not transition)
            isTransition = false;
            timeRemaining = current.duration;
            document.getElementById('transitionIndicator').classList.add('hidden');
            
            // Voice announcement
            let announcement = current.name;
            if (current.sides === "right") {
                announcement += " right";
            } else if (current.sides === "left") {
                announcement += " left";
            }
            
            if (isRunning || isPaused) {
                speak(announcement);
            }
            
            updateDisplay();
        }

        function goBack() {
            // Back works in any state - running, paused, or stopped
            if (currentStretchIndex <= 0) return; // Can't go back from first stretch
            
            // Move to previous stretch
            currentStretchIndex--;
            
            const current = stretches[currentStretchIndex];
            
            // Reset to the stretch (not transition)
            isTransition = false;
            timeRemaining = current.duration;
            document.getElementById('transitionIndicator').classList.add('hidden');
            
            // Voice announcement
            let announcement = current.name;
            if (current.sides === "right") {
                announcement += " right";
            } else if (current.sides === "left") {
                announcement += " left";
            }
            
            if (isRunning || isPaused) {
                speak(announcement);
            }
            
            updateDisplay();
        }

        function completeRoutine() {
            isRunning = false;
            isTransition = false;
            clearInterval(timer);
            
            speak("Complete");
            
            document.getElementById('stretchName').textContent = 'Routine Complete! 🎉';
            document.getElementById('stretchSide').textContent = '';
            document.getElementById('stretchInfo').textContent = 'Amazing work! Your body thanks you.';
            document.getElementById('stretchInstructions').textContent = '';
            document.getElementById('timerDisplay').textContent = '0:00';
            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('transitionIndicator').classList.add('hidden');
            
            releaseWakeLock();
        }

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('hidden');
            updateStretchList();
        }

        function addStretch() {
            const name = document.getElementById('newStretchName').value.trim();
            const description = document.getElementById('newStretchDescription').value.trim();
            const duration = parseInt(document.getElementById('newStretchDuration').value);
            const sides = document.getElementById('newStretchSides').value;
            const target = document.getElementById('newStretchTarget').value.trim();
            
            if (name && duration > 0 && target) {
                if (sides === "both") {
                    // Add both left and right versions
                    stretches.push({
                        name: name,
                        target: target,
                        duration: duration,
                        sides: "right",
                        icon: "🧘‍♀️",
                        description: description || "Stretch exercise",
                        searchTerms: name.toLowerCase()
                    });
                    stretches.push({
                        name: name,
                        target: target,
                        duration: duration,
                        sides: "left",
                        icon: "🧘‍♀️",
                        description: description || "Stretch exercise",
                        searchTerms: name.toLowerCase()
                    });
                } else {
                    stretches.push({
                        name: name,
                        target: target,
                        duration: duration,
                        sides: sides,
                        icon: "🧘‍♀️",
                        description: description || "Stretch exercise",
                        searchTerms: name.toLowerCase()
                    });
                }
                
                // Clear form
                document.getElementById('newStretchName').value = '';
                document.getElementById('newStretchDescription').value = '';
                document.getElementById('newStretchDuration').value = '60';
                document.getElementById('newStretchSides').value = 'none';
                document.getElementById('newStretchTarget').value = '';
                
                updateStretchList();
                updateTotalTime();
            }
        }

        function removeStretch(index) {
            stretches.splice(index, 1);
            updateStretchList();
            updateTotalTime();
        }

        function updateStretchList() {
            const list = document.getElementById('stretchList');
            list.innerHTML = '';
            
            stretches.forEach((stretch, index) => {
                const item = document.createElement('div');
                item.className = 'stretch-item';
                
                const details = document.createElement('div');
                details.className = 'stretch-details';
                
                const title = document.createElement('div');
                title.className = 'stretch-title';
                title.textContent = `${getStretchIcon(stretch)} ${stretch.name}`;
                if (stretch.sides !== "none") {
                    title.textContent += ` (${stretch.sides})`;
                }
                
                const meta = document.createElement('div');
                meta.className = 'stretch-meta';
                meta.textContent = `${stretch.target} • ${formatTime(stretch.duration)}`;
                
                details.appendChild(title);
                details.appendChild(meta);
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-outline';
                removeBtn.style.cssText = 'padding: 4px 12px; font-size: 0.8em; min-width: auto;';
                removeBtn.textContent = 'Remove';
                removeBtn.onclick = () => removeStretch(index);
                
                item.appendChild(details);
                item.appendChild(removeBtn);
                list.appendChild(item);
            });
        }

        function updateTotalTime() {
            const total = calculateTotalTime();
            document.getElementById('timeRemaining').textContent = `Total: ${formatTime(total)}`;
            
            if (!isRunning) {
                document.getElementById('timerDisplay').textContent = formatTime(total);
            }
        }

        // Event listeners
        document.getElementById('playPauseBtn').addEventListener('click', togglePlayPause);
        document.getElementById('stopBtn').addEventListener('click', stopRoutine);
        document.getElementById('backBtn').addEventListener('click', goBack);
        document.getElementById('skipBtn').addEventListener('click', skipNext);
        document.getElementById('settingsBtn').addEventListener('click', toggleSettings);
        document.getElementById('testVoiceBtn').addEventListener('click', testVoice);
        document.getElementById('addStretchBtn').addEventListener('click', addStretch);

        document.getElementById('voiceSpeed').addEventListener('input', function() {
            voiceSpeed = parseFloat(this.value);
            document.getElementById('speedValue').textContent = voiceSpeed.toFixed(1) + 'x';
        });

        document.getElementById('voicePitch').addEventListener('input', function() {
            voicePitch = parseFloat(this.value);
            document.getElementById('pitchValue').textContent = voicePitch.toFixed(1);
        });

        document.getElementById('voiceSelect').addEventListener('change', function() {
            const index = parseInt(this.value);
            selectedVoice = isNaN(index) ? null : voices[index];
        });

        document.getElementById('transitionTime').addEventListener('change', updateTotalTime);

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space') {
                e.preventDefault();
                togglePlayPause();
            } else if (e.code === 'Escape') {
                stopRoutine();
            } else if (e.code === 'ArrowRight') {
                e.preventDefault();
                skipNext();
            } else if (e.code === 'ArrowLeft') {
                e.preventDefault();
                goBack();
            }
        });

        // Mobile-specific event listeners
        document.addEventListener('touchstart', trackInteraction, { passive: true });
        document.addEventListener('touchend', trackInteraction, { passive: true });
        document.addEventListener('click', trackInteraction);

        // Check for screen wake periodically during workout
        setInterval(checkScreenWake, 10000);

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && isRunning) {
                console.log('App backgrounded during workout');
            } else if (!document.hidden && isRunning) {
                console.log('App foregrounded during workout');
                requestWakeLock();
            }
        });

        // Prevent accidental zoom on double tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Initialize
        updateDisplay();
        updateStretchList();
        updateTotalTime();
    </script>
</body>
</html>